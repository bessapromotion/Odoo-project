<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

    <!-- visite -->
    <record model="ir.ui.view" id="crm_visite_com_tree_view">
            <field name="name">crm.visite.tree</field>
            <field name="model">crm.visite</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree toolbar="1"  editable="top" string="Visites Commerciales" decoration-muted="state == 'cancel'" >
                    <field name="type_visite" invisible="1"/>
                    <field name="date"/>
                    <field name="name" attrs="{'required':  ['|',('type_visite' ,'in' , ('Commercial'))] }"/>
                    <field name="badge"/>
                    <field name="etat"/>
                    <field name="mobile" attrs="{'required':  ['|',('type_visite' ,'in' , ('Commercial'))] }"/>
                    <field name="source_id" options="{'no_create_edit':True}"/>
                    <field name="user_demand" options="{'no_create_edit':True}"/>
                    <field name="user_charge" options="{'no_create_edit':True}"/>
                    <field name="observation" attrs="{'required':  ['|',('type_visite' ,'in' , ('Commercial'))] }"/>
                    <field name="heure_entree"/>
                    <field name="heure_recu"/>
                    <field name="heure_sortie"/>
                    <field name="obs_hubspot"/>
                    <field name="tags_ids"  widget="many2many_tags"  options="{'color_field': 'color'}"/>
                    <field name="has_opportunity" />
                    <field name="opportunity_id" invisible="1"/>
                    <field name="state" invisible="1"/>
                    <button string="Convertir en Opportunité"
                            type="object"
                            name="action_button_convert2opportunity"
                            icon="fa-hand-pointer-o"
                            attrs="{'invisible':['|', ('opportunity_id','!=',False), ('state','=','cancel'),]}"/>
                </tree>
            </field>
        </record>

    <record model="ir.ui.view" id="crm_visite_form_view">
            <field name="name">crm.visite.form</field>
            <field name="model">crm.visite</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Visite">
                    <header>
                        <button string="Convertir en Opportunité"
                            type="object"
                            name="action_button_convert2opportunity"
                            icon="fa-hand-pointer-o"
                            attrs="{'invisible':['|', '|', ('opportunity_id','!=',False), ('state','=','cancel'), ('type_visite', 'in' , ('Employee', )) ]}" confirm="Vous êtes sur le point de créer une opportunité !"/>
                        <button name="action_cancel" string="Annuler" states="valid" type="object" confirm="Voulez vous annuler la visite?"/>
                        <field name="state" nolabel="1" widget="statusbar" statusbar_visible="valid"/>
                    </header>
                    <sheet>
                        <group>
                            <group>
                                <field name="type_visite" widget="radio" invisible="1"/>
                            </group>
                            <group>
                                <field name="date"/>
                            </group>
                        </group>
                        <group>
                            <group string="Visiteur">
                                <field name="badge"/>
                                <!--
                                <field name="name"/>
                                <field name="etat"/>
                                -->
                                <field name="visiteur_empl"
                                        placeholder="S'il n'est pas un client ou prospect, saisir son nom ici ..."
                                       attrs="{'invisible': [('type_visite', 'in' , ('Commercial', ))] ,'required':  ['|',('type_visite' ,'in' , ('Employee'))] }"/>
                            </group>
                             <group string="Commercial">
                                 <field name="user_demand"  attrs="{'invisible': [('type_visite', 'in' , ('Employee', ))] ,'required':  ['|',('type_visite' ,'in' , ('Commercial'))]}"/>
                                 <field name="user_charge"  attrs="{'invisible': [('type_visite', 'in' , ('Employee', ))]}"/>
                                 <field name="employee"  attrs="{'invisible': [('type_visite', 'in' , ('Commercial', ))] , 'required':  ['|',('type_visite' ,'in' , ('Employee'))]}"/>
                                 <field name="observation" string="Motif de visite"/>
                             </group>
                        </group>
                        <group>
                            <group string="Entrée/sortie">
                                <field name="heure_entree"/>
                                <field name="heure_recu"/>
                                <field name="heure_sortie"/>
                            </group>
                            <group string="Autres">
                                <field name="source_id"/>
                                  <field name="tags_ids"  widget="many2many_tags"  options="{'color_field': 'color'}"/>
                                  <field name="opportunity_id"  attrs="{'invisible': [('type_visite', 'in' , ('Employee', ))]}"/>
                            </group>
                        </group>
                        <group>
                            <field name="obs_hubspot" attrs="{'invisible': [('type_visite' , 'in' , ('Employee', ))]}"/>
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                         <field name="message_follower_ids" widget="mail_followers"/>
                         <field name="activity_ids" widget="mail_activity"/>
                         <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

    <record model="ir.ui.view" id="crm_visite_pivot_view">
            <field name="name">crm.visite.pivot</field>
            <field name="model">crm.visite</field>
            <field name="type">pivot</field>
            <field name="arch" type="xml">
                <pivot display_quantity="true"  string="Visite">
                    <field name="date"/>
                    <field name="name"/>
                    <field name="etat" />
                    <field name="source_id"/>
                    <field name="user_demand"/>
                    <field name="user_charge" type="col"/>
                    <field name="heure_entree"/>
                    <field name="heure_recu"/>
                    <field name="heure_sortie"/>
                    <field name="state"/>
                </pivot>
            </field>
        </record>

    <record id="view_crm_visite_filter" model="ir.ui.view">
            <field name="name">crm.visite.search.view</field>
            <field name="model">crm.visite</field>
            <field name="arch" type="xml">
                <search string="Status Search">
             <!-- permet une recherche "directe" -->
                     <group col="10" colspan="4">
                        <field name="name" filter_domain="['|', '|',  ('name.name', 'ilike', self), ('name.code_client', 'ilike', self), ('name.num_pi', 'ilike', self)]"/>
                        <field name="user_demand"/>
                        <field name="visiteur_empl"/>
                        <!--<field name="etat"/>-->
                        <field name="user_charge"/>
                        <field name="observation" />
                        <field name="obs_hubspot" />
                        <field name="source_id" />
                        <field name="tags_ids" />
                    </group>
                    <!-- Permet le regroupement -->
                    <separator/>
                    <group expand="0" string="Grouper par" >
                        <filter string="Client" name="Client" context="{'group_by':'name'}" />
                        <filter string="Commercial chargé" name="user_charge" context="{'group_by':'user_charge'}" />
                        <filter string="Source" name="source_id" context="{'group_by':'source_id'}" />
                    </group>
                    <separator/>
                     <!-- permet un filtrage -->
                     <filter name="tenue" string="Effectuées" domain="[('state', '!=', 'cancel')]"/>
                    <filter name="canceled" string="Annulées" domain="[('state', '=', 'cancel')]"/>
                    <separator/>
                    <filter name="opportunity" string="Transformées en opportunités" domain="[('opportunity_id', '!=', False)]"/>

                </search>
            </field>
        </record>

    <record model="ir.actions.act_window" id="action_crm_visite_com_tree_view">
        <field name="name">Visites Commerciales</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">crm.visite</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form,pivot</field>
        <field name="view_id" ref="crm_visite_com_tree_view"/>
        <field name="search_view_id" ref="view_crm_visite_filter"/>
        <field name="context">{'default_type_visite': 'Commercial'}</field>
        <field name="domain">[('type_visite', '=', 'Commercial')]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cliquez ici pour créer un nouvelle visite.
            </p><p>

            </p><p>

            </p>
         </field>
    </record>

    </data>
</openerp>
